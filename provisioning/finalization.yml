# ansible-playbook -u vagrant -i 192.168.56.100, provisioning/finalization.yml
- name: Finalize initialization of Kubernetes cluster
  hosts: all
  become: yes
  become_user: vagrant
  vars:
    dashboard_admin_yaml: | 
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: admin-user
        namespace: kubernetes-dashboard
      ---
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: admin-user
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
      - kind: ServiceAccount
        name: admin-user
        namespace: kubernetes-dashboard
    dashboard_ingress_yaml: |
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: dashboard-ingress
        namespace: kubernetes-dashboard
        annotations:
          nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          # nginx.ingress.kubernetes.io/secure-backends: "true"
          # nginx.ingress.kubernetes.io/ssl-redirect: "true"
          # nginx.ingress.kubernetes.io/ssl-passthrough: "true"
      spec:
        ingressClassName: nginx
        rules:
          - host: "dashboard.local"
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: kubernetes-dashboard-kong-proxy
                      port:
                        number: 443

  tasks:
    # Step 20: Install MetalLB
    - name: Apply MetalLB CRDs
      shell: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml

    - name: Wait for MetalLB controller pod to be ready
      shell: >
        kubectl wait -n metallb-system 
        -l app=metallb,component=controller
        --for=condition=ready pod 
        --timeout=300s

    - name: Configure IPAddressPool
      copy:
        dest: /tmp/metallb-pool.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            namespace: metallb-system
            name: default-pool
          spec:
            addresses:
              - 192.168.56.90-192.168.56.99

    - name: Apply IPAddressPool
      command: kubectl apply -f /tmp/metallb-pool.yaml

    - name: Configure L2Advertisement
      copy:
        dest: /tmp/metallb-l2.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            namespace: metallb-system
            name: l2
          spec: {}

    - name: Apply L2Advertisement
      command: kubectl apply -f /tmp/metallb-l2.yaml

    # Step 21: Install Nginx Ingress Controller
    - name: "Add Nginx Ingress repository"
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx
        state: present

    - name: "Install Nginx Ingress controller chart"
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: yes
        state: present
        values:
          controller:
            service:
              loadBalancerIP: 192.168.56.91

    - name: Wait for ingress-nginx controller to be ready
      shell: >
        kubectl wait -n ingress-nginx 
        -l app.kubernetes.io/component=controller 
        --for=condition=ready pod 
        --timeout=60s

    # Step 22: Install Kubernetes Dashboard
    - name: "Add Kubernetes dashboard repository"
      kubernetes.core.helm_repository:
        name: "kubernetes-dashboard"
        repo_url: https://kubernetes.github.io/dashboard/
        state: present

    - name: "Install Kubernetes dashboard chart"
      kubernetes.core.helm:
        name: "kubernetes-dashboard"
        chart_ref: "kubernetes-dashboard/kubernetes-dashboard"
        release_namespace: kubernetes-dashboard 
        create_namespace: yes        
        state: present       

    - name: Create 'admin user config' (ServiceAccount & ClusterRoleBinding)
      copy:
        dest: /tmp/dashboard-admin.yaml
        content: "{{ dashboard_admin_yaml }}"
          
    - name: Apply admin user config
      command: kubectl apply -f /tmp/dashboard-admin.yaml

    - name: Create dashboard Ingress
      copy:
        dest: /tmp/dashboard-ingress.yaml
        content: "{{ dashboard_ingress_yaml }}"

    - name: Apply dashboard ingress
      command: kubectl apply -f /tmp/dashboard-ingress.yaml

    - name: Create admin token
      command: kubectl -n kubernetes-dashboard create token admin-user
      register: dashboard_token

    - name: Show dashboard login token and next steps
      debug:
        msg: 
          - "Kubernetes dashboard ready. Next steps:"
          - ">> Add the line '192.168.56.91 dashboard.local' to your host's hostfile"
          - ">> Go to https://dashboard.local and enter the following token: {{ dashboard_token.stdout }}"

    # Step 23: Install Istio
    - name: Download Istio 1.25.2
      get_url:
        url: https://github.com/istio/istio/releases/download/1.25.2/istio-1.25.2-linux-amd64.tar.gz
        dest: /tmp/istio.tar.gz
        mode: '0644'
      become: true

    - name: Extract Istio
      unarchive:
        src: /tmp/istio.tar.gz
        dest: /opt/
        remote_src: yes
      become: true

    ### TODO make idempotent
    # - name: Add istioctl to PATH
    #   lineinfile:
    #     path: /home/vagrant/.bashrc
    #     line: 'export PATH=$PATH:/opt/istio-1.25.2/bin'
    #     insertafter: EOF
    #     regexp: '^export PATH=.*:/opt/istio-1\.25\.2/bin'
    #     state: present

    # - name: Run istioctl install (demo profile)
    #   shell: |
    #     /opt/istio-1.25.2/bin/istioctl install --set profile=demo -y
    #   args:
    #     creates: /opt/istio-1.25.2/manifests
